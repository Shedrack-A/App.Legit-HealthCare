{% extends "base.html" %}

{% block navigation %}
<!-- Hide side navigation -->
{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="card auth-card" style="max-width: 800px;">
        <div class="card-header">
            <h2>Patient Portal Sign-Up</h2>
        </div>

        <!-- Step 1: Search for Staff ID -->
        <div id="search-step">
            <p class="text-secondary">To begin, please enter your Staff ID to find your record in our system.</p>
            <div class="d-flex gap-2">
                <input type="text" id="staff-id-search" class="form-control" placeholder="Enter your Staff ID...">
                <button type="button" id="search-btn" class="btn btn-primary">Search</button>
            </div>
            <div id="search-error" class="text-danger mt-2" style="display: none;"></div>
        </div>

        <!-- Step 2: Confirm Details and Create Account -->
        <form id="signup-form" method="POST" action="{{ url_for('portal.signup') }}" style="display: none;">
            {{ form.hidden_tag() }}
            <p class="text-secondary">We found your record! Please confirm the details below, make any necessary corrections, and create a password for your portal account.</p>

            <h4>Confirm Your Bio-Data</h4>
            <div class="row">
                <div class="col-md-6 form-group">{{ form.staff_id.label }} {{ form.staff_id(class="form-control", readonly=True) }}</div>
                <div class="col-md-6 form-group">{{ form.first_name.label }} {{ form.first_name(class="form-control") }}</div>
                <div class="col-md-6 form-group">{{ form.last_name.label }} {{ form.last_name(class="form-control") }}</div>
                <div class="col-md-6 form-group">{{ form.middle_name.label }} {{ form.middle_name(class="form-control") }}</div>
                <div class="col-md-6 form-group">{{ form.date_of_birth.label }} {{ form.date_of_birth(class="form-control", readonly=True) }}</div>
                <div class="col-md-6 form-group">{{ form.department.label }} {{ form.department(class="form-control", readonly=True) }}</div>
                <div class="col-md-6 form-group">{{ form.gender.label }} {{ form.gender(class="form-control") }}</div>
                <div class="col-md-6 form-group">{{ form.phone_number.label }} {{ form.phone_number(class="form-control") }}</div>
                <div class="col-md-12 form-group">{{ form.email.label }} {{ form.email(class="form-control") }}</div>
            </div>

            <h4 class="mt-4">Create Your Password</h4>
            <div class="row">
                <div class="col-md-6 form-group">
                    {{ form.password.label }}
                    {{ form.password(class="form-control") }}
                </div>
                <div class="col-md-6 form-group">
                    {{ form.confirm_password.label }}
                    {{ form.confirm_password(class="form-control") }}
                </div>
            </div>

            {{ form.submit(class="btn btn-primary w-100 mt-4") }}
        </form>

        <div class="auth-footer">
            <p>Already have an account? <a href="{{ url_for('portal.login') }}">Login</a></p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchBtn = document.getElementById('search-btn');
    const searchInput = document.getElementById('staff-id-search');
    const searchError = document.getElementById('search-error');
    const searchStep = document.getElementById('search-step');
    const signupForm = document.getElementById('signup-form');

    searchBtn.addEventListener('click', function() {
        const staffId = searchInput.value;
        if (!staffId) {
            searchError.textContent = 'Please enter a Staff ID.';
            searchError.style.display = 'block';
            return;
        }
        searchError.style.display = 'none';

        // Add loading state to button
        searchBtn.disabled = true;
        searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Searching...';

        fetch(`/portal/api/patient_search?staff_id=${staffId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    searchError.textContent = data.error;
                    searchError.style.display = 'block';
                } else {
                    document.querySelector('[name="staff_id"]').value = data.staff_id;
                    document.querySelector('[name="first_name"]').value = data.first_name;
                    document.querySelector('[name="last_name"]').value = data.last_name;
                    document.querySelector('[name="middle_name"]').value = data.middle_name || '';
                    document.querySelector('[name="date_of_birth"]').value = data.date_of_birth;
                    document.querySelector('[name="department"]').value = data.department;
                    document.querySelector('[name="gender"]').value = data.gender;
                    document.querySelector('[name="phone_number"]').value = data.phone_number;
                    document.querySelector('[name="email"]').value = data.email;

                    searchStep.style.display = 'none';
                    signupForm.style.display = 'block';
                }
            })
            .catch(err => {
                searchError.textContent = 'An error occurred. Please try again.';
                searchError.style.display = 'block';
            })
            .finally(() => {
                // Restore button state
                searchBtn.disabled = false;
                searchBtn.innerHTML = 'Search';
            });
    });
});
</script>
{% endblock %}
