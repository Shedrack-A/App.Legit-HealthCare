{% extends "base.html" %}
{% from "_form_helpers.html" import render_field %}

{% block navigation %}
<!-- Hide side navigation -->
{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-card">
        <div id="search-step">
            <div class="auth-header">
                <h2>Patient Portal Sign-Up</h2>
                <p>To begin, please enter your Staff ID to find your record.</p>
            </div>
            <div class="form-group">
                <input type="text" id="staff-id-search" class="form-control" placeholder="Enter your Staff ID...">
            </div>
            <div class="form-group">
                <button type="button" id="search-btn" class="btn btn-primary btn-block">Search</button>
            </div>
            <div id="search-error" class="alert alert-danger" style="display: none;"></div>
        </div>

        <form id="signup-form" method="POST" action="" style="display: none;" novalidate>
            {{ form.hidden_tag() }}
            <div class="auth-header">
                <h2>Confirm Your Details</h2>
                <p>Please confirm your details and create a password.</p>
            </div>

            {{ render_field(form.staff_id, readonly=True) }}
            {{ render_field(form.first_name) }}
            {{ render_field(form.last_name) }}
            {{ render_field(form.middle_name) }}
            {{ render_field(form.date_of_birth, readonly=True) }}
            {{ render_field(form.department, readonly=True) }}
            {{ render_field(form.gender) }}
            {{ render_field(form.phone_number) }}
            {{ render_field(form.email) }}

            <hr>

            {{ render_field(form.password) }}
            {{ render_field(form.confirm_password) }}

            <div class="form-group">
                {{ form.submit(class="btn btn-primary btn-block") }}
            </div>
        </form>
        <div class="auth-footer">
            <p>Already have an account? <a href="{{ url_for('portal.login') }}" class="auth-link">Sign In</a></p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchBtn = document.getElementById('search-btn');
    const searchInput = document.getElementById('staff-id-search');
    const searchError = document.getElementById('search-error');
    const searchStep = document.getElementById('search-step');
    const signupForm = document.getElementById('signup-form');

    searchBtn.addEventListener('click', function() {
        const staffId = searchInput.value;
        if (!staffId) {
            searchError.textContent = 'Please enter a Staff ID.';
            searchError.style.display = 'block';
            return;
        }
        searchError.style.display = 'none';

        fetch(`/portal/api/patient_search?staff_id=${staffId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    searchError.textContent = data.error;
                    searchError.style.display = 'block';
                } else {
                    // Populate the form
                    document.querySelector('[name="staff_id"]').value = data.staff_id;
                    document.querySelector('[name="first_name"]').value = data.first_name;
                    document.querySelector('[name="last_name"]').value = data.last_name;
                    document.querySelector('[name="middle_name"]').value = data.middle_name;
                    document.querySelector('[name="date_of_birth"]').value = data.date_of_birth;
                    document.querySelector('[name="department"]').value = data.department;
                    document.querySelector('[name="gender"]').value = data.gender;
                    document.querySelector('[name="phone_number"]').value = data.phone_number;
                    document.querySelector('[name="email"]').value = data.email;

                    // Hide search step and show form
                    searchStep.style.display = 'none';
                    signupForm.style.display = 'block';
                }
            })
            .catch(err => {
                searchError.textContent = 'An error occurred. Please try again.';
                searchError.style.display = 'block';
            });
    });
});
</script>
{% endblock %}
