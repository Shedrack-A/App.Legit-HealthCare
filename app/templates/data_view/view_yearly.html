{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>{{ title }}</h2>
        <p class="text-secondary">This page shows patients registered for the selected company and screening year.</p>
    </div>

    <form id="search-form" class="mb-4">
        <input id="search-input" type="text" name="search" class="form-control" placeholder="Search by Staff ID or Name...">
    </form>

    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>Patient ID</th>
                    <th>Staff ID</th>
                    <th>Name</th>
                    <th>Screening Year</th>
                    <th>Company</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="records-tbody">
                <!-- Records will be injected by JS -->
            </tbody>
        </table>
    </div>
    <div id="pagination-container" class="pagination">
        <!-- Pagination links will be injected by JS -->
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('search-input');
    const recordsTbody = document.getElementById('records-tbody');
    const paginationContainer = document.getElementById('pagination-container');
    let currentPage = 1;
    let currentSearch = '';

    function fetchRecords() {
        const url = new URL("{{ url_for('data_view.api_search_yearly_records') }}", window.location.origin);
        url.searchParams.set('page', currentPage);
        url.searchParams.set('search', currentSearch);

        fetch(url)
            .then(response => response.json())
            .then(data => {
                updateTable(data.patients);
                updatePagination(data);
            })
            .catch(error => console.error('Error fetching records:', error));
    }

    function updateTable(patients) {
        recordsTbody.innerHTML = '';
        if (patients.length > 0) {
            patients.forEach(p => {
                const editUrl = `{{ url_for('data_view.edit_patient', patient_id=0) }}`.replace('0', p.id);
                const deleteUrl = `{{ url_for('data_view.delete_patient', patient_id=0) }}`.replace('0', p.id);
                const row = `
                    <tr>
                        <td>${p.patient_id}</td>
                        <td>${p.staff_id}</td>
                        <td>${p.first_name} ${p.last_name}</td>
                        <td>${p.screening_year}</td>
                        <td>${p.company}</td>
                        <td>
                            <a href="${editUrl}" class="btn btn-sm btn-secondary"><i class="fas fa-edit"></i> Edit</a>
                            <form action="${deleteUrl}" method="POST" style="display:inline;" onsubmit="return confirm('Are you sure?');">
                                <button type="submit" class="btn btn-sm btn-danger"><i class="fas fa-trash-alt"></i> Delete</button>
                            </form>
                        </td>
                    </tr>`;
                recordsTbody.innerHTML += row;
            });
        } else {
            recordsTbody.innerHTML = '<tr><td colspan="6" class="text-center">No records found.</td></tr>';
        }
    }

    function updatePagination(data) {
        paginationContainer.innerHTML = '';
        if (data.pages <= 1) return;

        let links = '';
        // Previous link
        links += `<a href="#" data-page="${data.prev_num}" class="${data.has_prev ? '' : 'disabled'}">&laquo;</a>`;
        // Page links
        for (let i = 1; i <= data.pages; i++) {
            links += `<a href="#" data-page="${i}" class="${i === data.page ? 'current-page' : ''}">${i}</a>`;
        }
        // Next link
        links += `<a href="#" data-page="${data.next_num}" class="${data.has_next ? '' : 'disabled'}">&raquo;</a>`;
        paginationContainer.innerHTML = links;
    }

    let searchTimeout;
    searchInput.addEventListener('keyup', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentPage = 1;
            currentSearch = searchInput.value;
            fetchRecords();
        }, 300);
    });

    paginationContainer.addEventListener('click', function(e) {
        e.preventDefault();
        if (e.target.tagName === 'A' && !e.target.classList.contains('disabled')) {
            currentPage = e.target.dataset.page;
            fetchRecords();
        }
    });

    // Initial load
    fetchRecords();
});
</script>
{% endblock %}
